<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunny â€” Calorie Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&family=Pacifico&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
<style>
  :root {
    --bg: #fdf8f4;
    --surface: #ffffff;
    --rose: #f2a8b4;
    --sage: #b5d4c0;
    --lavender: #d4c5f0;
    --butter: #f7e8b0;
    --peach: #f9c9b0;
    --text: #3a2e2e;
    --muted: #a89898;
    --border: #f0e8e0;
    --shadow: rgba(180,140,120,0.12);
    --danger: #e88080;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: radial-gradient(circle, rgba(180,140,120,0.07) 1px, transparent 1px);
    background-size: 24px 24px;
    pointer-events: none;
    z-index: 0;
  }

  .app {
    max-width: 390px;
    margin: 0 auto;
    min-height: 100vh;
    position: relative;
    z-index: 1;
    padding-bottom: 110px;
  }

  /* â”€â”€ HEADER â”€â”€ */
  .header {
    padding: 48px 20px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 16px;
  }

  .logo-text {
    font-family: 'Pacifico', cursive;
    font-size: 19px;
    background: linear-gradient(135deg, #f9a825, #ff7043);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .date-pill {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 30px;
    padding: 6px 13px;
    font-size: 11px;
    font-weight: 500;
    color: var(--muted);
    box-shadow: 0 2px 8px var(--shadow);
  }

  /* â”€â”€ CARDS â”€â”€ */
  .card {
    margin: 0 16px 12px;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 24px;
    padding: 20px;
    box-shadow: 0 2px 12px var(--shadow);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }

  .card-title {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
  }

  .card-action {
    background: transparent;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--rose);
    cursor: pointer;
  }

  /* â”€â”€ STATS ROW â”€â”€ */
  .stats-row {
    display: flex;
    gap: 10px;
    padding: 0 16px 12px;
  }

  .stat-pill {
    flex: 1;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 20px;
    padding: 14px 10px;
    text-align: center;
    box-shadow: 0 2px 8px var(--shadow);
  }

  .stat-pill.clickable { cursor: pointer; }

  .stat-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    margin: 0 auto 6px;
  }

  .stat-num {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    line-height: 1;
  }

  .stat-lbl {
    font-size: 10px;
    color: var(--muted);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 3px;
  }

  /* â”€â”€ MACRO BARS â”€â”€ */
  .macro-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    font-weight: 500;
    margin-bottom: 5px;
  }

  .macro-name { color: var(--muted); }

  .bar-track {
    height: 7px;
    background: var(--border);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 11px;
  }

  .bar-track:last-child { margin-bottom: 0; }

  .bar-fill {
    height: 100%;
    border-radius: 20px;
    transition: width 0.7s ease;
  }

  /* â”€â”€ HABITS â”€â”€ */
  .habit-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 11px 13px;
    border-radius: 16px;
    cursor: pointer;
    border: 1.5px solid var(--border);
    background: var(--bg);
    transition: all 0.2s;
    margin-bottom: 8px;
  }

  .habit-item:last-child { margin-bottom: 0; }

  .habit-item.done {
    background: linear-gradient(135deg, #f0faf4, #e8f7ee);
    border-color: var(--sage);
  }

  .habit-check {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid var(--border);
    background: transparent;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
  }

  .habit-item.done .habit-check {
    border-color: var(--sage);
    background: var(--sage);
  }

  .habit-emoji { font-size: 17px; }

  .habit-label {
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .habit-item.done .habit-label {
    color: var(--sage);
    text-decoration: line-through;
    opacity: 0.8;
  }

  /* â”€â”€ TABS â”€â”€ */
  .tab-row {
    display: flex;
    padding: 0 16px;
    gap: 8px;
    margin-bottom: 16px;
  }

  .tab {
    flex: 1;
    padding: 10px 0;
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    border-radius: 16px;
    cursor: pointer;
    border: 1.5px solid var(--border);
    background: var(--surface);
    color: var(--muted);
    transition: all 0.2s;
    box-shadow: 0 2px 8px var(--shadow);
  }

  .tab.active {
    background: var(--text);
    color: var(--bg);
    border-color: var(--text);
  }

  /* â”€â”€ PANELS â”€â”€ */
  .panel { display: none; padding: 0 16px; }
  .panel.active { display: block; }

  .section-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 12px;
  }

  /* â”€â”€ BUTTONS â”€â”€ */
  .btn-primary {
    width: 100%;
    background: var(--text);
    color: var(--bg);
    border: none;
    border-radius: 18px;
    padding: 15px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-bottom: 10px;
    box-shadow: 0 4px 14px rgba(58,46,46,0.18);
    transition: transform 0.15s, opacity 0.2s;
  }

  .btn-primary:active { transform: scale(0.97); }

  .btn-primary.sage {
    background: var(--sage);
    color: var(--text);
    box-shadow: 0 4px 14px rgba(130,190,150,0.25);
  }

  .btn-ghost {
    width: 100%;
    background: var(--surface);
    color: var(--text);
    border: 1.5px solid var(--border);
    border-radius: 18px;
    padding: 13px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    margin-bottom: 18px;
    box-shadow: 0 2px 8px var(--shadow);
    transition: border-color 0.2s;
  }

  .btn-ghost:hover { border-color: var(--rose); }

  /* â”€â”€ FOOD & WORKOUT ITEMS â”€â”€ */
  .log-item {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 18px;
    padding: 13px 15px;
    margin-bottom: 9px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 2px 8px var(--shadow);
    animation: popIn 0.25s cubic-bezier(.34,1.56,.64,1);
  }

  @keyframes popIn {
    from { opacity: 0; transform: scale(0.95) translateY(5px); }
    to   { opacity: 1; transform: scale(1) translateY(0); }
  }

  .log-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .log-emoji {
    width: 36px;
    height: 36px;
    border-radius: 12px;
    background: linear-gradient(135deg, #e8f5ec, #d4f0dc);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }

  .log-info { flex: 1; min-width: 0; }

  .log-name {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .log-meta {
    font-size: 11px;
    color: var(--muted);
    margin-top: 1px;
  }

  .log-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

  .log-cal {
    font-family: 'DM Serif Display', serif;
    font-size: 17px;
    text-align: right;
  }

  .log-cal-lbl { font-size: 10px; color: var(--muted); }

  .del-btn {
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: var(--border);
    border: none;
    color: var(--muted);
    font-size: 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s, color 0.2s;
    flex-shrink: 0;
  }

  .del-btn:hover { background: #fde8e8; color: #d44; }

  /* â”€â”€ PLAN BOX â”€â”€ */
  .plan-box {
    background: var(--surface);
    border: 1.5px solid #d8eee0;
    border-radius: 20px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px var(--shadow);
  }

  .plan-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  .plan-save-btn {
    background: var(--sage);
    border: none;
    border-radius: 20px;
    padding: 5px 13px;
    font-family: 'DM Sans', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
  }

  .plan-textarea {
    width: 100%;
    background: #f7faf8;
    border: 1.5px solid #d8eee0;
    border-radius: 13px;
    padding: 11px 13px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: var(--text);
    resize: none;
    height: 76px;
    line-height: 1.5;
    outline: none;
    transition: border-color 0.2s;
  }

  .plan-textarea:focus { border-color: var(--sage); }

  /* â”€â”€ INFO BADGE â”€â”€ */
  .info-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    background: #edf7f0;
    border: 1.5px solid #cde8d8;
    border-radius: 14px;
    padding: 9px 13px;
    font-size: 12px;
    color: #5a9a72;
    font-weight: 500;
    margin-bottom: 14px;
  }

  /* â”€â”€ EMPTY STATE â”€â”€ */
  .empty {
    text-align: center;
    padding: 32px 0;
    color: var(--muted);
    font-size: 13px;
  }

  .empty-icon { font-size: 34px; margin-bottom: 8px; }

  /* â”€â”€ BOTTOM BAR â”€â”€ */
  .bottom-bar {
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 390px;
    padding: 12px 20px 28px;
    background: rgba(253,248,244,0.94);
    backdrop-filter: blur(20px);
    border-top: 1.5px solid var(--border);
    z-index: 50;
  }

  /* â”€â”€ SHEETS â”€â”€ */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(58,46,46,0.2);
    backdrop-filter: blur(8px);
    z-index: 100;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.28s;
  }

  .overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .sheet {
    background: var(--bg);
    border-radius: 28px 28px 0 0;
    padding: 8px 22px 44px;
    width: 100%;
    max-width: 390px;
    transform: translateY(24px);
    transition: transform 0.32s cubic-bezier(.4,0,.2,1);
    border-top: 1.5px solid var(--border);
    max-height: 88vh;
    overflow-y: auto;
  }

  .overlay.open .sheet { transform: translateY(0); }

  .sheet-handle {
    width: 34px;
    height: 4px;
    background: var(--border);
    border-radius: 4px;
    margin: 11px auto 20px;
  }

  .sheet-title {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    margin-bottom: 3px;
  }

  .sheet-sub {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 20px;
  }

  /* â”€â”€ FORM â”€â”€ */
  .field { margin-bottom: 14px; }

  .field-label {
    display: block;
    font-size: 11px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 7px;
  }

  .field-input {
    width: 100%;
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 13px;
    padding: 12px 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text);
    transition: border-color 0.2s;
    box-shadow: 0 2px 6px var(--shadow);
  }

  .field-input:focus { outline: none; border-color: var(--rose); }

  .field-row { display: flex; gap: 10px; }
  .field-row .field { flex: 1; }

  select.field-input { cursor: pointer; }

  .btn-submit {
    width: 100%;
    background: var(--text);
    color: var(--bg);
    border: none;
    border-radius: 15px;
    padding: 14px;
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 4px;
    box-shadow: 0 4px 14px rgba(58,46,46,0.18);
    transition: opacity 0.2s;
  }

  .btn-submit.sage {
    background: var(--sage);
    color: var(--text);
    box-shadow: 0 4px 14px rgba(130,190,150,0.25);
  }

  .btn-submit:hover { opacity: 0.88; }

  .btn-cancel {
    width: 100%;
    background: transparent;
    border: none;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    color: var(--muted);
    padding: 11px;
    cursor: pointer;
    margin-top: 4px;
  }

  /* â”€â”€ PRESETS â”€â”€ */
  .presets {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 18px;
  }

  .preset-btn {
    flex: 1;
    min-width: calc(33% - 6px);
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 13px;
    padding: 11px 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    box-shadow: 0 2px 6px var(--shadow);
    transition: all 0.18s;
  }

  .preset-btn:hover, .preset-btn.selected {
    background: var(--rose);
    color: #fff;
    border-color: var(--rose);
  }

  /* â”€â”€ SCANNER â”€â”€ */
  #scanner-container {
    width: 100%;
    border-radius: 18px;
    overflow: hidden;
    background: #111;
    min-height: 175px;
    position: relative;
    margin-bottom: 12px;
  }

  #scanner-container video,
  #scanner-container canvas { width: 100% !important; border-radius: 18px; }

  .scan-frame-wrap {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
  }

  .scan-frame {
    width: 185px;
    height: 66px;
    border: 2px solid rgba(255,255,255,0.75);
    border-radius: 10px;
    position: relative;
    box-shadow: 0 0 0 4000px rgba(0,0,0,0.3);
  }

  .scan-line {
    position: absolute;
    left: 0; right: 0;
    height: 2px;
    background: var(--rose);
    animation: scanAnim 1.8s ease-in-out infinite;
    box-shadow: 0 0 8px var(--rose);
  }

  @keyframes scanAnim {
    0%, 100% { top: 0; }
    50% { top: calc(100% - 2px); }
  }

  .scanned-card {
    background: linear-gradient(135deg, #fef0f3, #fff8f5);
    border: 1.5px solid #f5d0da;
    border-radius: 16px;
    padding: 14px;
    margin-bottom: 14px;
  }

  .scanned-name { font-size: 15px; font-weight: 600; margin-bottom: 2px; }
  .scanned-brand { font-size: 12px; color: var(--muted); margin-bottom: 10px; }
  .scanned-macros { display: flex; gap: 16px; }
  .scanned-mac { text-align: center; }
  .scanned-val { font-family: 'DM Serif Display', serif; font-size: 17px; }
  .scanned-lbl { font-size: 10px; color: var(--muted); text-transform: uppercase; }

  /* â”€â”€ TOAST â”€â”€ */
  .toast {
    position: fixed;
    top: 22px;
    left: 50%;
    transform: translateX(-50%) translateY(-70px);
    background: var(--text);
    color: var(--bg);
    padding: 11px 20px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 500;
    z-index: 200;
    transition: transform 0.32s cubic-bezier(.34,1.56,.64,1);
    white-space: nowrap;
    box-shadow: 0 4px 18px rgba(58,46,46,0.22);
  }

  .toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div class="app">

  <!-- HEADER -->
  <div class="header">
    <div class="logo">
      â˜€ï¸ <span class="logo-text">Sunny</span>
    </div>
    <div style="display:flex;align-items:center;gap:6px;">
      <button id="prev-day-btn" onclick="changeDay(-1)" style="background:var(--surface);border:1.5px solid var(--border);border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px var(--shadow);">â€¹</button>
      <div class="date-pill" id="date-pill"></div>
      <button id="next-day-btn" onclick="changeDay(1)" style="background:var(--surface);border:1.5px solid var(--border);border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 6px var(--shadow);">â€º</button>
    </div>
  </div>

  <!-- STATS ROW -->


  <!-- NUTRITION GOALS CARD -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">Nutrition goals</div>
      <button class="card-action" onclick="openNutritionSheet()">edit âœï¸</button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:13px;">
      <span style="font-size:12px;font-weight:500;color:var(--muted);">Calories left</span>
      <span style="display:flex;align-items:center;gap:8px;">
        <span style="font-family:'DM Serif Display',serif;font-size:16px;" id="s-left">2000</span>
        <button onclick="openCalGoal()" style="background:transparent;border:none;font-family:'DM Sans',sans-serif;font-size:11px;font-weight:600;color:var(--rose);cursor:pointer;">set goal âœï¸</button>
      </span>
    </div>
    <div id="nutrition-display"></div>
  </div>

  <!-- DAILY HABITS CARD -->
  <div class="card">
    <div class="card-header">
      <div class="card-title">Daily habits</div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div id="habit-count" style="font-size:11px;font-weight:600;color:var(--rose);"></div>
        <button class="card-action" onclick="openHabitEditor()">edit âœï¸</button>
      </div>
    </div>
    <div id="habit-list"></div>
  </div>

  <!-- TABS -->
  <div class="tab-row">
    <button class="tab active" onclick="switchTab('food')">ğŸ“ Food</button>
    <button class="tab" onclick="switchTab('workout')">ğŸŒ¿ Workout</button>
  </div>

  <!-- FOOD PANEL -->
  <div class="panel active" id="panel-food">
    <div class="section-label">Today's log</div>
    <button class="btn-primary" onclick="openScanner()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>
        <line x1="7" y1="12" x2="17" y2="12"/>
      </svg>
      Scan Barcode
    </button>
    <button class="btn-ghost" onclick="openManualFood()">+ Add manually</button>
    <div id="food-list"></div>
  </div>

  <!-- WORKOUT PANEL -->
  <div class="panel" id="panel-workout">
    <div class="section-label">Today's plan</div>
    <div class="plan-box">
      <div class="plan-header">
        <div class="card-title">Workout plan</div>
        <button class="plan-save-btn" onclick="savePlan()">save</button>
      </div>
      <textarea class="plan-textarea" id="plan-input" placeholder="e.g. Morning run 5k + upper body ğŸ’ª"></textarea>
    </div>

    <div class="section-label">Logged workouts</div>
    <div class="info-badge">ğŸŒ¿ Calories burned are tracked separately from your food goal</div>
    <button class="btn-primary sage" onclick="openWorkoutSheet()">+ Log a workout</button>
    <div id="workout-list"></div>
  </div>

</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <button class="btn-primary" style="margin:0;" onclick="openScanner()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
      <path d="M3 7V5a2 2 0 0 1 2-2h2M17 3h2a2 2 0 0 1 2 2v2M21 17v2a2 2 0 0 1-2 2h-2M7 21H5a2 2 0 0 1-2-2v-2"/>
      <line x1="7" y1="12" x2="17" y2="12"/>
    </svg>
    Quick Scan
  </button>
</div>

<!-- SCANNER SHEET -->
<div class="overlay" id="scanner-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Scan a barcode</div>
    <div class="sheet-sub">Point your camera at the product</div>
    <div id="scanner-container">
      <div class="scan-frame-wrap">
        <div class="scan-frame"><div class="scan-line"></div></div>
      </div>
    </div>
    <div id="scan-result"></div>
    <button class="btn-cancel" onclick="closeScanner()">Cancel</button>
  </div>
</div>

<!-- MANUAL FOOD SHEET -->
<div class="overlay" id="manual-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Add food</div>
    <div class="sheet-sub">Enter the nutrition info</div>
    <div class="field">
      <label class="field-label">Food name</label>
      <input class="field-input" id="f-name" type="text" placeholder="e.g. Greek Yogurt"/>
    </div>
    <div class="field-row">
      <div class="field">
        <label class="field-label">Calories</label>
        <input class="field-input" id="f-cal" type="number" placeholder="0"/>
      </div>
      <div class="field">
        <label class="field-label">Serving (g)</label>
        <input class="field-input" id="f-serving" type="number" placeholder="100"/>
      </div>
    </div>
    <div class="field-row">
      <div class="field">
        <label class="field-label">Protein (g)</label>
        <input class="field-input" id="f-protein" type="number" placeholder="0"/>
      </div>
      <div class="field">
        <label class="field-label">Carbs (g)</label>
        <input class="field-input" id="f-carbs" type="number" placeholder="0"/>
      </div>
      <div class="field">
        <label class="field-label">Fat (g)</label>
        <input class="field-input" id="f-fat" type="number" placeholder="0"/>
      </div>
    </div>
    <button class="btn-submit" onclick="submitFood()">Add to log âœ“</button>
    <button class="btn-cancel" onclick="closeManualFood()">Cancel</button>
  </div>
</div>

<!-- WORKOUT SHEET -->
<div class="overlay" id="workout-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Log workout</div>
    <div class="sheet-sub">How did you move today?</div>
    <div class="field">
      <label class="field-label">Exercise</label>
      <select class="field-input" id="w-type">
        <option value="running">ğŸƒ Running</option>
        <option value="cycling">ğŸš´ Cycling</option>
        <option value="swimming">ğŸŠ Swimming</option>
        <option value="weights">ğŸ‹ï¸ Weight Training</option>
        <option value="hiit">âš¡ HIIT</option>
        <option value="yoga">ğŸ§˜ Yoga</option>
        <option value="walking">ğŸš¶ Walking</option>
        <option value="pilates">ğŸ©° Pilates</option>
        <option value="other">ğŸ’ª Other</option>
      </select>
    </div>
    <div class="field-row">
      <div class="field">
        <label class="field-label">Duration (min)</label>
        <input class="field-input" id="w-duration" type="number" placeholder="30"/>
      </div>
      <div class="field">
        <label class="field-label">Calories burned</label>
        <input class="field-input" id="w-cal" type="number" placeholder="200"/>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Notes (optional)</label>
      <input class="field-input" id="w-notes" type="text" placeholder="How did it feel?"/>
    </div>
    <button class="btn-submit sage" onclick="submitWorkout()">Save workout âœ“</button>
    <button class="btn-cancel" onclick="closeWorkoutSheet()">Cancel</button>
  </div>
</div>

<!-- CALORIE GOAL SHEET -->
<div class="overlay" id="cal-goal-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Daily calorie goal</div>
    <div class="sheet-sub">Tap a preset or enter your own</div>
    <div class="presets">
      <button class="preset-btn" onclick="selectPreset(this, 1200)">1200</button>
      <button class="preset-btn" onclick="selectPreset(this, 1500)">1500</button>
      <button class="preset-btn" onclick="selectPreset(this, 1800)">1800</button>
      <button class="preset-btn" onclick="selectPreset(this, 2000)">2000</button>
      <button class="preset-btn" onclick="selectPreset(this, 2200)">2200</button>
      <button class="preset-btn" onclick="selectPreset(this, 2500)">2500</button>
    </div>
    <div class="field">
      <label class="field-label">Custom (kcal)</label>
      <input class="field-input" id="cal-goal-input" type="number" placeholder="e.g. 1750"/>
    </div>
    <button class="btn-submit" onclick="saveCalGoal()">Save goal âœ“</button>
    <button class="btn-cancel" onclick="closeCalGoal()">Cancel</button>
  </div>
</div>

<!-- NUTRITION GOALS SHEET -->
<div class="overlay" id="nutrition-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Nutrition goals</div>
    <div class="sheet-sub">Set your daily macro targets</div>
    <div class="field">
      <label class="field-label">Protein target (g)</label>
      <input class="field-input" id="ng-protein" type="number" placeholder="e.g. 150"/>
    </div>
    <div class="field">
      <label class="field-label">Carbs target (g)</label>
      <input class="field-input" id="ng-carbs" type="number" placeholder="e.g. 200"/>
    </div>
    <div class="field">
      <label class="field-label">Fat target (g)</label>
      <input class="field-input" id="ng-fat" type="number" placeholder="e.g. 65"/>
    </div>
    <button class="btn-submit" onclick="saveNutritionGoals()">Save goals âœ“</button>
    <button class="btn-cancel" onclick="closeNutritionSheet()">Cancel</button>
  </div>
</div>

<!-- HABIT EDITOR SHEET -->
<div class="overlay" id="habit-editor-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Edit habits</div>
    <div class="sheet-sub">Drag to reorder, tap to rename or delete</div>
    <div id="habit-editor-list" style="margin-bottom:16px;"></div>
    <button class="btn-submit" style="background:var(--surface);color:var(--text);border:1.5px dashed var(--border);box-shadow:none;margin-bottom:10px;" onclick="addNewHabit()">+ Add habit</button>
    <button class="btn-submit" onclick="saveHabitEdits()">Done âœ“</button>
    <button class="btn-cancel" onclick="closeHabitEditor()">Cancel</button>
  </div>
</div>

<!-- HABIT RENAME SHEET -->
<div class="overlay" id="habit-rename-overlay">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">Edit habit</div>
    <div class="sheet-sub">Change the name and emoji</div>
    <div class="field">
      <label class="field-label">Emoji</label>
      <input class="field-input" id="habit-emoji-input" type="text" maxlength="2" placeholder="e.g. ğŸƒ"/>
    </div>
    <div class="field">
      <label class="field-label">Habit name</label>
      <input class="field-input" id="habit-name-input" type="text" placeholder="e.g. Drink 8 glasses of water"/>
    </div>
    <button class="btn-submit" onclick="saveHabitRename()">Save âœ“</button>
    <button class="btn-cancel" onclick="closeHabitRename()">Cancel</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Settings persist forever; daily data is keyed by date
let settings = {
  calorieGoal: 2000,
  nutritionGoals: { protein: 150, carbs: 200, fat: 65 },
};

// viewDate is the date currently being viewed (may be past)
let viewOffset = 0; // 0 = today, -1 = yesterday, etc.

function getDateKey(offset) {
  const d = new Date();
  d.setDate(d.getDate() + offset);
  return d.toISOString().slice(0, 10);
}

function getTodayKey() { return getDateKey(0); }
function isToday() { return viewOffset === 0; }

function getDayData(key) {
  try {
    const s = localStorage.getItem('sunny_day_' + key);
    return s ? JSON.parse(s) : { foods: [], workouts: [] };
  } catch(e) { return { foods: [], workouts: [] }; }
}

function saveDayData(key, data) {
  try { localStorage.setItem('sunny_day_' + key, JSON.stringify(data)); } catch(e) {}
}

function loadSettings() {
  try {
    const s = localStorage.getItem('sunny_settings');
    if (s) settings = { ...settings, ...JSON.parse(s) };
  } catch(e) {}
}

function saveSettings() {
  try { localStorage.setItem('sunny_settings', JSON.stringify(settings)); } catch(e) {}
}

function getCurrentDayData() { return getDayData(getDateKey(viewOffset)); }
function saveCurrentDayData(data) { saveDayData(getDateKey(viewOffset), data); }

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadSettings();
updateDateHeader();

// â”€â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2400);
}

function openOverlay(id) { document.getElementById(id).classList.add('open'); }
function closeOverlay(id) { document.getElementById(id).classList.remove('open'); }

function switchTab(t) {
  document.querySelectorAll('.tab').forEach((el, i) =>
    el.classList.toggle('active', ['food','workout'][i] === t));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`panel-${t}`).classList.add('active');
}

// â”€â”€â”€ TOTALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getTotals() {
  const d = getCurrentDayData();
  return {
    cals:    d.foods.reduce((s, f) => s + f.calories, 0),
    protein: d.foods.reduce((s, f) => s + (f.protein || 0), 0),
    carbs:   d.foods.reduce((s, f) => s + (f.carbs || 0), 0),
    fat:     d.foods.reduce((s, f) => s + (f.fat || 0), 0),
    burned:  d.workouts.reduce((s, w) => s + w.calories, 0),
  };
}

// â”€â”€â”€ DATE NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDateHeader() {
  const d = new Date();
  d.setDate(d.getDate() + viewOffset);
  const label = viewOffset === 0 ? 'Today' :
    viewOffset === -1 ? 'Yesterday' :
    d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
  document.getElementById('date-pill').textContent = label;
  // Hide next button on today
  document.getElementById('next-day-btn').style.opacity = viewOffset === 0 ? '0.3' : '1';
  document.getElementById('next-day-btn').style.pointerEvents = viewOffset === 0 ? 'none' : 'auto';
  // Disable editing on past days
  const past = !isToday();
  document.querySelectorAll('.btn-primary, .btn-ghost, .plan-save-btn').forEach(b => {
    b.style.opacity = past ? '0.4' : '1';
    b.style.pointerEvents = past ? 'none' : 'auto';
  });
}

function changeDay(dir) {
  if (dir === 1 && viewOffset === 0) return;
  viewOffset += dir;
  updateDateHeader();
  updateDash();
  renderFoods();
  renderWorkouts();
  renderHabits();
  loadPlan();
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDash() {
  const { cals, protein, carbs, fat } = getTotals();
  const goal = settings.calorieGoal;
  document.getElementById('s-left').textContent = Math.max(0, goal - cals);

  renderNutrition(protein, carbs, fat);
}

// â”€â”€â”€ NUTRITION GOALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderNutrition(protein, carbs, fat) {
  const g = settings.nutritionGoals;
  const items = [
    { label:'Protein', val: protein, target: g.protein, color:'var(--rose)' },
    { label:'Carbs',   val: carbs,   target: g.carbs,   color:'var(--butter)' },
    { label:'Fat',     val: fat,     target: g.fat,     color:'var(--lavender)' },
  ];
  document.getElementById('nutrition-display').innerHTML = items.map(item => {
    const pct  = Math.min(100, (item.val / item.target) * 100);
    const over = item.val > item.target;
    return `
      <div class="macro-row">
        <span class="macro-name">${item.label}</span>
        <span style="font-size:12px;font-weight:500;color:${over ? 'var(--danger)' : 'var(--muted)'}">
          ${item.val}g <span style="font-weight:400;">/ ${item.target}g</span>
        </span>
      </div>
      <div class="bar-track">
        <div class="bar-fill" style="width:${pct}%;background:${over ? 'var(--danger)' : item.color};"></div>
      </div>`;
  }).join('');
}

function openNutritionSheet() {
  const g = settings.nutritionGoals;
  document.getElementById('ng-protein').value = g.protein;
  document.getElementById('ng-carbs').value   = g.carbs;
  document.getElementById('ng-fat').value     = g.fat;
  openOverlay('nutrition-overlay');
}

function closeNutritionSheet() { closeOverlay('nutrition-overlay'); }

function saveNutritionGoals() {
  settings.nutritionGoals = {
    protein: parseInt(document.getElementById('ng-protein').value) || 150,
    carbs:   parseInt(document.getElementById('ng-carbs').value)   || 200,
    fat:     parseInt(document.getElementById('ng-fat').value)      || 65,
  };
  saveSettings();
  closeNutritionSheet();
  updateDash();
  toast('ğŸŒ¸ Nutrition goals saved!');
}

// â”€â”€â”€ HABITS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_HABITS = [
  { id:'journal', label:'Journaled today', emoji:'ğŸ“”' },
  { id:'workout', label:'Worked out',      emoji:'ğŸƒ' },
  { id:'wakeup',  label:'Woke up on time', emoji:'â˜€ï¸' },
];

function getHabitDefs() {
  try {
    const s = localStorage.getItem('sunny_habit_defs');
    return s ? JSON.parse(s) : DEFAULT_HABITS;
  } catch(e) { return DEFAULT_HABITS; }
}

function saveHabitDefs(defs) {
  try { localStorage.setItem('sunny_habit_defs', JSON.stringify(defs)); } catch(e) {}
}

function getHabitChecks() {
  try {
    const s = localStorage.getItem('sunny_habits_' + getDateKey(viewOffset));
    return s ? JSON.parse(s) : {};
  } catch(e) { return {}; }
}

function saveHabitChecks(h) {
  try { localStorage.setItem('sunny_habits_' + getDateKey(viewOffset), JSON.stringify(h)); } catch(e) {}
}

function toggleHabit(id) {
  const h = getHabitChecks();
  h[id] = !h[id];
  saveHabitChecks(h);
  renderHabits();
}

function renderHabits() {
  const defs = getHabitDefs();
  const h = getHabitChecks();
  const done = defs.filter(x => h[x.id]).length;
  document.getElementById('habit-count').textContent =
    done === defs.length ? 'ğŸ‰ All done!' : `${done}/${defs.length} done`;

  document.getElementById('habit-list').innerHTML = defs.map(x => `
    <div class="habit-item ${h[x.id] ? 'done' : ''}" onclick="toggleHabit('${x.id}')">
      <div class="habit-check">
        ${h[x.id] ? `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3.5"><polyline points="20 6 9 17 4 12"/></svg>` : ''}
      </div>
      <span class="habit-emoji">${x.emoji}</span>
      <span class="habit-label">${x.label}</span>
    </div>`).join('');
}

// â”€â”€â”€ HABIT EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editingHabits = [];
let renamingIndex = -1;
let dragSrcIdx = null;

function openHabitEditor() {
  editingHabits = JSON.parse(JSON.stringify(getHabitDefs()));
  renderHabitEditorList();
  openOverlay('habit-editor-overlay');
}

function closeHabitEditor() { closeOverlay('habit-editor-overlay'); }

function renderHabitEditorList() {
  document.getElementById('habit-editor-list').innerHTML = editingHabits.map((h, i) => `
    <div draggable="true" ondragstart="dragStart(${i})" ondragover="dragOver(event,${i})" ondrop="dragDrop(${i})" ondragend="dragEnd()"
      style="display:flex;align-items:center;gap:10px;padding:11px 13px;background:var(--surface);border:1.5px solid var(--border);border-radius:16px;margin-bottom:8px;cursor:grab;transition:opacity 0.2s;" id="habit-edit-row-${i}">
      <span style="color:var(--muted);font-size:16px;cursor:grab;">â ¿</span>
      <span style="font-size:17px;">${h.emoji}</span>
      <span style="flex:1;font-size:13px;font-weight:500;">${h.label}</span>
      <button onclick="openHabitRename(${i})" style="background:transparent;border:none;font-size:11px;font-weight:600;color:var(--rose);cursor:pointer;padding:4px 8px;">edit</button>
      <button onclick="deleteHabit(${i})" style="background:#fde8e8;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;color:#d44;font-size:14px;display:flex;align-items:center;justify-content:center;">Ã—</button>
    </div>`).join('');
}

function deleteHabit(i) {
  editingHabits.splice(i, 1);
  renderHabitEditorList();
}

function addNewHabit() {
  editingHabits.push({ id: 'habit_' + Date.now(), label: 'New habit', emoji: 'â­' });
  renderHabitEditorList();
  openHabitRename(editingHabits.length - 1);
}

function saveHabitEdits() {
  saveHabitDefs(editingHabits);
  closeHabitEditor();
  renderHabits();
  toast('ğŸŒ¸ Habits updated!');
}

// Rename
function openHabitRename(i) {
  renamingIndex = i;
  document.getElementById('habit-emoji-input').value = editingHabits[i].emoji;
  document.getElementById('habit-name-input').value  = editingHabits[i].label;
  openOverlay('habit-rename-overlay');
}

function closeHabitRename() { closeOverlay('habit-rename-overlay'); }

function saveHabitRename() {
  const emoji = document.getElementById('habit-emoji-input').value.trim() || 'â­';
  const label = document.getElementById('habit-name-input').value.trim();
  if (!label) { toast('Please enter a habit name'); return; }
  editingHabits[renamingIndex].emoji = emoji;
  editingHabits[renamingIndex].label = label;
  closeHabitRename();
  renderHabitEditorList();
}

// Drag to reorder
function dragStart(i) {
  dragSrcIdx = i;
  setTimeout(() => {
    const el = document.getElementById('habit-edit-row-' + i);
    if (el) el.style.opacity = '0.4';
  }, 0);
}

function dragOver(e, i) {
  e.preventDefault();
}

function dragDrop(i) {
  if (dragSrcIdx === null || dragSrcIdx === i) return;
  const moved = editingHabits.splice(dragSrcIdx, 1)[0];
  editingHabits.splice(i, 0, moved);
  dragSrcIdx = null;
  renderHabitEditorList();
}

function dragEnd() {
  dragSrcIdx = null;
  renderHabitEditorList();
}

// â”€â”€â”€ FOOD LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFoods() {
  const el = document.getElementById('food-list');
  const dayData = getCurrentDayData();
  if (!dayData.foods.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ğŸŒ¸</div>Nothing logged yet<br><span style="font-size:11px;">Scan a barcode or add manually</span></div>`;
    return;
  }
  el.innerHTML = dayData.foods.map((f, i) => `
    <div class="log-item">
      <div class="log-dot" style="background:var(--rose)"></div>
      <div class="log-info">
        <div class="log-name">${f.name}</div>
        <div class="log-meta">${f.serving || 100}g Â· P:${f.protein||0} C:${f.carbs||0} F:${f.fat||0}</div>
      </div>
      <div class="log-right">
        <div>
          <div class="log-cal">${f.calories}</div>
          <div class="log-cal-lbl">kcal</div>
        </div>
        <button class="del-btn" onclick="delFood(${i})">Ã—</button>
      </div>
    </div>`).join('');
}

function delFood(i) {
  if (!isToday()) return;
  const d = getCurrentDayData();
  d.foods.splice(i, 1);
  saveCurrentDayData(d);
  renderFoods(); updateDash();
}

function openManualFood() {
  ['f-name','f-cal','f-serving','f-protein','f-carbs','f-fat']
    .forEach(id => document.getElementById(id).value = '');
  openOverlay('manual-overlay');
}

function closeManualFood() { closeOverlay('manual-overlay'); }

function submitFood() {
  const name = document.getElementById('f-name').value.trim();
  const cals = parseInt(document.getElementById('f-cal').value) || 0;
  if (!name || !cals) { toast('Please enter name & calories'); return; }
  if (!isToday()) return;
  const fd = getCurrentDayData();
  fd.foods.push({
    id: Date.now(), name, calories: cals,
    serving: parseInt(document.getElementById('f-serving').value) || 100,
    protein: parseInt(document.getElementById('f-protein').value) || 0,
    carbs:   parseInt(document.getElementById('f-carbs').value)   || 0,
    fat:     parseInt(document.getElementById('f-fat').value)     || 0,
  });
  saveCurrentDayData(fd); closeManualFood(); renderFoods(); updateDash();
  toast(`ğŸŒ¸ ${name} added!`);
}

// â”€â”€â”€ SCANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scanning = false;

function openScanner() {
  document.getElementById('scan-result').innerHTML = '';
  openOverlay('scanner-overlay');
  startScan();
}

function closeScanner() {
  closeOverlay('scanner-overlay');
  stopScan();
}

function startScan() {
  if (scanning) return;
  scanning = true;
  Quagga.init({
    inputStream: {
      name: 'Live', type: 'LiveStream',
      target: document.getElementById('scanner-container'),
      constraints: { facingMode: 'environment', width: 360, height: 200 }
    },
    decoder: { readers: ['ean_reader','ean_8_reader','upc_reader','upc_e_reader','code_128_reader'] },
    locate: true,
  }, err => {
    if (err) {
      document.getElementById('scan-result').innerHTML =
        `<div style="padding:11px;background:#fef0f0;border:1.5px solid #f5ccc8;border-radius:13px;font-size:13px;color:#c0605a;margin-bottom:10px;">Camera unavailable â€” please add food manually.</div>`;
      return;
    }
    Quagga.start();
  });
  Quagga.onDetected(onBarcode);
}

function stopScan() {
  if (!scanning) return;
  Quagga.offDetected(onBarcode);
  try { Quagga.stop(); } catch(e) {}
  scanning = false;
}

async function onBarcode(result) {
  const code = result.codeResult.code;
  stopScan();
  document.getElementById('scan-result').innerHTML =
    `<div style="text-align:center;padding:14px;color:var(--muted);font-size:13px;">ğŸ” Looking up <strong>${code}</strong>â€¦</div>`;
  try {
    const res  = await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
    const data = await res.json();
    if (data.status === 1) {
      const p = data.product, n = p.nutriments || {};
      const prod = {
        name:     p.product_name || 'Unknown Product',
        brand:    p.brands || '',
        calories: Math.round(n['energy-kcal_100g'] || n['energy-kcal'] || 0),
        protein:  Math.round(n.proteins_100g || 0),
        carbs:    Math.round(n.carbohydrates_100g || 0),
        fat:      Math.round(n.fat_100g || 0),
        serving:  p.serving_quantity || 100,
      };
      document.getElementById('scan-result').innerHTML = `
        <div class="scanned-card">
          <div class="scanned-name">${prod.name}</div>
          ${prod.brand ? `<div class="scanned-brand">${prod.brand}</div>` : ''}
          <div class="scanned-macros">
            <div class="scanned-mac"><div class="scanned-val">${prod.calories}</div><div class="scanned-lbl">kcal</div></div>
            <div class="scanned-mac"><div class="scanned-val">${prod.protein}g</div><div class="scanned-lbl">protein</div></div>
            <div class="scanned-mac"><div class="scanned-val">${prod.carbs}g</div><div class="scanned-lbl">carbs</div></div>
            <div class="scanned-mac"><div class="scanned-val">${prod.fat}g</div><div class="scanned-lbl">fat</div></div>
          </div>
        </div>
        <button class="btn-submit" onclick='addScanned(${JSON.stringify(prod)})'>Add to log âœ“</button>`;
    } else {
      document.getElementById('scan-result').innerHTML =
        `<div style="padding:11px;background:#fffbec;border:1.5px solid #f0e0a0;border-radius:13px;font-size:13px;color:#8a7020;margin-bottom:10px;">Product not found â€” try adding manually!</div>`;
    }
  } catch(e) {
    document.getElementById('scan-result').innerHTML =
      `<div style="padding:11px;background:#fef0f0;border:1.5px solid #f5ccc8;border-radius:13px;font-size:13px;color:#c0605a;margin-bottom:10px;">Connection error â€” try adding manually.</div>`;
  }
}

function addScanned(prod) {
  if (!isToday()) return;
  const sd = getCurrentDayData();
  sd.foods.push({ ...prod, id: Date.now() });
  saveCurrentDayData(sd); closeScanner(); renderFoods(); updateDash();
  toast(`ğŸŒ¸ ${prod.name} added!`);
}

// â”€â”€â”€ WORKOUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WE = { running:'ğŸƒ', cycling:'ğŸš´', swimming:'ğŸŠ', weights:'ğŸ‹ï¸', hiit:'âš¡', yoga:'ğŸ§˜', walking:'ğŸš¶', pilates:'ğŸ©°', other:'ğŸ’ª' };

function renderWorkouts() {
  const el = document.getElementById('workout-list');
  const wd = getCurrentDayData();
  if (!wd.workouts.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">ğŸŒ¿</div>No workouts logged yet</div>`;
    return;
  }
  el.innerHTML = wd.workouts.map((w, i) => `
    <div class="log-item">
      <div class="log-emoji">${WE[w.type] || 'ğŸ’ª'}</div>
      <div class="log-info">
        <div class="log-name">${w.type.charAt(0).toUpperCase() + w.type.slice(1)}</div>
        <div class="log-meta">${w.duration} min${w.notes ? ' Â· ' + w.notes : ''}</div>
      </div>
      <div class="log-right">
        <div>
          <div class="log-cal" style="color:var(--sage)">${w.calories}</div>
          <div class="log-cal-lbl">kcal</div>
        </div>
        <button class="del-btn" onclick="delWorkout(${i})">Ã—</button>
      </div>
    </div>`).join('');
}

function delWorkout(i) {
  if (!isToday()) return;
  const d = getCurrentDayData();
  d.workouts.splice(i, 1);
  saveCurrentDayData(d); renderWorkouts();
}

function openWorkoutSheet() {
  ['w-duration','w-cal','w-notes'].forEach(id => document.getElementById(id).value = '');
  openOverlay('workout-overlay');
}

function closeWorkoutSheet() { closeOverlay('workout-overlay'); }

function submitWorkout() {
  const dur = parseInt(document.getElementById('w-duration').value) || 0;
  if (!dur) { toast('Please enter duration'); return; }
  if (!isToday()) return;
  const wd2 = getCurrentDayData();
  wd2.workouts.push({
    id: Date.now(),
    type:     document.getElementById('w-type').value,
    duration: dur,
    calories: parseInt(document.getElementById('w-cal').value) || 0,
    notes:    document.getElementById('w-notes').value.trim(),
  });
  saveCurrentDayData(wd2); closeWorkoutSheet(); renderWorkouts();
  toast('ğŸŒ¿ Workout saved!');
}

// â”€â”€â”€ WORKOUT PLAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function savePlan() {
  const plan = document.getElementById('plan-input').value.trim();
  try { localStorage.setItem('sunny_plan_' + getDateKey(viewOffset), plan); } catch(e) {}
  toast('ğŸŒ¿ Plan saved!');
}

function loadPlan() {
  try {
    const p = localStorage.getItem('sunny_plan_' + getDateKey(viewOffset));
    document.getElementById('plan-input').value = p || '';
  } catch(e) {}
}

// â”€â”€â”€ CALORIE GOAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCalGoal() {
  document.getElementById('cal-goal-input').value = settings.calorieGoal;
  document.querySelectorAll('.preset-btn').forEach(b =>
    b.classList.toggle('selected', parseInt(b.textContent) === settings.calorieGoal));
  openOverlay('cal-goal-overlay');
}

function closeCalGoal() { closeOverlay('cal-goal-overlay'); }

function selectPreset(btn, val) {
  document.getElementById('cal-goal-input').value = val;
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

function saveCalGoal() {
  const val = parseInt(document.getElementById('cal-goal-input').value);
  if (!val || val < 500 || val > 9999) { toast('Enter a goal between 500â€“9999 kcal'); return; }
  settings.calorieGoal = val;
  saveSettings(); closeCalGoal(); updateDash();
  toast(`ğŸ¯ Goal set to ${val} kcal!`);
}

// â”€â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
updateDash();
renderFoods();
renderWorkouts();
renderHabits();
loadPlan();

// Add past-day read-only banner
function updateReadOnlyBanner() {
  let banner = document.getElementById('readonly-banner');
  if (!isToday()) {
    if (!banner) {
      banner = document.createElement('div');
      banner.id = 'readonly-banner';
      banner.style = 'margin:0 16px 12px;background:#fff8f0;border:1.5px solid #f9c9b0;border-radius:16px;padding:10px 14px;font-size:12px;color:#b07040;font-weight:500;text-align:center;';
      banner.textContent = 'ğŸ“… Viewing a past day â€” read only';
      document.querySelector('.card').before(banner);
    }
  } else {
    if (banner) banner.remove();
  }
}

const origChangeDay = changeDay;
window.changeDay = function(dir) {
  origChangeDay(dir);
  updateReadOnlyBanner();
};
</script>
</body>
</html>
